<!-- books/templates/books/book_detail.html -->
{% extends 'base.html' %}
{% load static %}
{% block title %}{{ book.name }}{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-4">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Trang chủ</a></li>
    {% if breadcrumb %}
      {% for cat in breadcrumb %}
        <li class="breadcrumb-item"><a href="{% url 'books:category_detail' cat.slug %}">{{ cat.name }}</a></li>
      {% endfor %}
    {% endif %}
    {% if category %}
      <li class="breadcrumb-item"><a href="{% url 'books:category_detail' category.slug %}">{{ category.name }}</a></li>
    {% endif %}
    <li class="breadcrumb-item active" aria-current="page">{{ book.name }}</li>
  </ol>
</nav>

<div class="row">
  <div class="col-md-4">
    <div class="mb-3 position-relative group-image">
      <div class="position-absolute top-0 start-0 p-2 z-1">
        {% if user.is_authenticated %}
          <button type="button" class="btn btn-light btn-sm rounded-circle wishlist-toggle-btn" aria-label="Yêu thích"
                  data-product-id="{{ book.id }}"
                  data-in-wishlist="{% if book.id in wishlist_ids %}1{% else %}0{% endif %}">
            {% if book.id in wishlist_ids %}
              <i class="bi bi-heart-fill text-danger"></i>
            {% else %}
              <i class="bi bi-heart text-danger"></i>
            {% endif %}
          </button>
        {% else %}
          <a href="{% url 'users:login' %}?next={{ request.get_full_path }}" class="btn btn-light btn-sm rounded-circle wishlist-toggle-btn" aria-label="Yêu thích">
            <i class="bi bi-heart text-danger"></i>
          </a>
        {% endif %}
      </div>
    {% if book.cover_image %}
      <img id="main-product-img" src="{{ book.cover_image.url }}" class="img-fluid rounded shadow-lg w-100" style="aspect-ratio: 2/3; object-fit: cover; cursor: pointer;" alt="{{ book.name }}" data-bs-toggle="modal" data-bs-target="#imageModal">
      <div class="position-absolute bottom-0 end-0 p-2">
         <button class="btn btn-light btn-sm rounded-circle shadow" data-bs-toggle="modal" data-bs-target="#imageModal"><i class="bi bi-arrows-fullscreen"></i></button>
      </div>
    {% else %}
      <div class="bg-light rounded d-flex align-items-center justify-content-center w-100" style="aspect-ratio: 2/3;">
        <span class="text-muted">Không có ảnh bìa</span>
      </div>
    {% endif %}
    </div>

    {% if book.images.exists or book.cover_image %}
    <div class="d-flex overflow-auto gap-2 pb-2" style="scrollbar-width: thin;">
        {% if book.cover_image %}
        <img src="{{ book.cover_image.url }}" 
             class="rounded border thumbnail-img" 
             style="width: 70px; aspect-ratio: 2/3; object-fit: cover; cursor: pointer; opacity: 1; border: 2px solid #0d6efd;"
             onclick="updateMainImage(this)">
        {% endif %}
        {% for img in book.images.all %}
        <img src="{{ img.image.url }}" 
             class="rounded border thumbnail-img" 
             style="width: 70px; aspect-ratio: 2/3; object-fit: cover; cursor: pointer; opacity: 0.6;"
             onclick="updateMainImage(this)">
        {% endfor %}
    </div>
    {% endif %}
  </div>
  <div class="col-md-8">
    <h1>{{ book.name }}</h1>
    {% for attr_val in book.attribute_values.all %}
        {% if attr_val.attribute.name == "Tác giả" %}
             <h4 class="text-muted">Tác giả: <strong>{{ attr_val.value }}</strong></h4>
        {% endif %}
    {% endfor %}
    <hr>
    <div class="d-flex align-items-baseline mb-3 fs-5">
        {% load custom_filters %}
        <span class="price me-3 fs-5">{{ book.get_final_price|vnd_currency }}</span>
        {% if book.is_on_sale %}
          <span class="original-price fs-5 text-decoration-line-through text-muted">{{ book.price|vnd_currency }}</span>
          <span class="badge bg-danger ms-2">-{{ book.discount_percentage }}%</span>
        {% endif %}
    </div>
    <p class="fs-5"><strong>Tồn kho:</strong> 
        {% if book.in_stock %}
            <span class="badge bg-success">Còn hàng</span>
        {% else %}
            <span class="badge bg-danger">Hết hàng</span>
        {% endif %}
    </p>

    <div class="mt-4">
    <form action="{% url 'orders:cart_add' book.id %}" method="post" id="add-to-cart-form" data-cart-detail-url="{% url 'orders:cart_detail' %}">
          {% csrf_token %}
          <div class="row align-items-center">
              <div class="col-md-4 col-lg-3">
                  <label for="quantity" class="form-label"><strong>Số lượng:</strong></label>
                  {{ cart_product_form.quantity }}
                  {{ cart_product_form.override }}
              </div>
              <div class="col-md-8 col-lg-9 mt-3 mt-md-0">
                  <button type="submit" class="btn btn-success btn-lg w-100">
                      <i class="bi bi-cart-plus-fill"></i> Thêm vào giỏ hàng
                  </button>
              </div>
          </div>
      </form>
    </div>

    <hr>
    
    <div class="mb-5">
        <h4>Thông tin chi tiết</h4>
        <table class="table table-striped table-bordered">
            <tbody>
                {% for attr_val in book.attribute_values.all %}
                    <tr>
                        <th scope="row" class="w-25">{{ attr_val.attribute.name }}</th>
                        <td>{{ attr_val.value }}</td>
                    </tr>
                {% empty %}
                    <tr><td colspan="2">Chưa có thông tin chi tiết.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <h4>Mô tả sản phẩm</h4>
    <div id="description-wrapper" style="position: relative; max-height: 150px; overflow: hidden; transition: max-height 0.5s ease;">
        <div id="description-content">
            {{ book.description|linebreaks }}
        </div>
        <div id="fade-overlay" style="position: absolute; bottom: 0; left: 0; width: 100%; height: 50px; background: linear-gradient(transparent, white);"></div>
    </div>
    <div class="text-center mt-2">
         <button id="toggle-desc-btn" class="btn btn-sm btn-primary d-none" onclick="toggleDescription()">Xem thêm <i class="bi bi-chevron-down"></i></button>
    </div>
    
  </div>
</div>

<hr class="my-5">

<div class="row">
    <div class="col-md-8">
        <h4 class="mb-4">Đánh giá sản phẩm ({{ book.reviews.count }})</h4>
        {% for review in book.reviews.all %}
            <div class="d-flex mb-4">
                <div class="flex-shrink-0">
                    <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                        {{ review.user.username|first|upper }}
                    </div>
                </div>
                <div class="ms-3 w-100">
                    <div class="d-flex justify-content-between">
                      <h6 class="fw-bold mb-1">{{ review.user.get_full_name|default:review.user.username }}</h6>
                      {% if review.user == request.user %}
                        <a href="{% url 'reviews:review_edit' review.pk %}" class="btn btn-sm btn-outline-secondary">
                          <i class="bi bi-pencil-square"></i> Sửa
                        </a>
                      {% endif %}
                    </div>
                    <div class="text-warning mb-2">
                        {% for i in "12345" %}
                            <i class="bi {% if i|add:0 <= review.rating %}bi-star-fill{% else %}bi-star{% endif %}"></i>
                        {% endfor %}
                    </div>
                    <p>{{ review.comment }}</p>
                    <small class="text-muted">{{ review.created_at|timesince }} trước</small>
                </div>
            </div>
        {% empty %}
            <p class="text-muted">Chưa có đánh giá nào cho sản phẩm này.</p>
        {% endfor %}
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Viết đánh giá của bạn</h5>
          {% if user.is_authenticated %}
            <form action="{% url 'reviews:review_add' book.id %}" method="post">
              {% csrf_token %}
              <div class="mb-3">
                <label for="rating" class="form-label">Chất lượng</label>
                <select name="rating" id="rating" class="form-select">
                  <option value="5">5 sao (Tuyệt vời)</option>
                  <option value="4">4 sao (Tốt)</option>
                  <option value="3">3 sao (Bình thường)</option>
                  <option value="2">2 sao (Tệ)</option>
                  <option value="1">1 sao (Rất tệ)</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="comment" class="form-label">Bình luận</label>
                <textarea name="comment" id="comment" rows="4" class="form-control" required></textarea>
              </div>
              <button type="submit" class="btn btn-primary w-100">Gửi đánh giá</button>
            </form>
          {% else %}
            <p class="text-muted mb-3">Bạn cần đăng nhập để viết bình luận.</p>
            <a href="{% url 'users:login' %}?next={{ request.get_full_path }}" class="btn btn-outline-primary w-100">Đăng nhập để bình luận</a>
          {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-transparent border-0 shadow-none">
      <div class="modal-body p-0 text-center position-relative">
        <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3 z-3 bg-white" data-bs-dismiss="modal" aria-label="Close"></button>
        <img src="" id="modal-img-content" class="img-fluid rounded shadow-lg" style="max-height: 90vh;">
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/book_detail.js' %}"></script>
{% endblock %}