{% load static %}

<div class="card mb-4">
  <div class="card-body">
    <h5 class="fw-bold mb-4">THIẾT LẬP TÀI KHOẢN</h5>
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="row">
        <!-- FORM -->
        <div class="col-md-8">      
          <div class="mb-3"><label>Tên đăng nhập</label><input class="form-control" value="{{ request.user.username }}" disabled></div>
          <div class="mb-3">
            <label class="form-label">Họ</label>
            {{ profile_form.first_name }}
            {% for error in profile_form.first_name.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          </div>
          <div class="mb-3">
            <label class="form-label">Tên</label>
            {{ profile_form.last_name }}
            {% for error in profile_form.last_name.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          </div>
          <div class="mb-3">
            <label>Ngày sinh</label>
            {{ profile_form.date_of_birth }}
            {% for error in profile_form.date_of_birth.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          </div>
          <div class="mb-3">
            <label>Số điện thoại</label>
            {{ profile_form.phone }}
            {% for error in profile_form.phone.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          </div>
          <div class="mb-3"><label>Email</label><input class="form-control" value="{{ display_email }}" disabled></div>
        </div>
          <div class="col-md-4 d-flex flex-column align-items-center text-center">
          <!-- Avatar -->
            <label for="id_avatar" style="cursor:pointer;">
              {% if request.user.profile.avatar %}
                <img id="avatarPreview"
                    src="{{ request.user.profile.avatar.url }}"
                    class="rounded-circle mb-2" width="120" height="120" style="object-fit:cover;">
              {% elif request.user.socialaccount_set.first %}
                <img id="avatarPreview"
                    src="{{ request.user.socialaccount_set.first.get_avatar_url }}"
                    class="rounded-circle mb-2" width="120" height="120" style="object-fit:cover;">
              {% else %}
                <div id="avatarPreview"
                    class="bg-secondary rounded-circle mb-2"
                    style="width:120px;height:120px;"></div>
              {% endif %}
            </label>
          <!-- Input file (ẩn) -->
          {{ profile_form.avatar }}
          <small class="text-muted">Nhấn vào ảnh để thay đổi</small>
        </div>
      </div>
      <div class="d-flex justify-content-center mt-4">
            <button class="btn btn-success px-4" name="save_profile">Lưu thay đổi</button>
      </div>
    </form>
  </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const input = document.getElementById("id_avatar");
    if (!input) return;
    input.addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (!file) return;
        const validTypes = ["jpg", "jpeg", "png", "gif", "webp"];
        const ext = file.name.split(".").pop().toLowerCase();
        if (!validTypes.includes(ext)) {
            alert("Vui lòng chọn file ảnh (jpg, png, jpeg, webp)");
            input.value = "";
            return;
        }
        const reader = new FileReader();
        reader.onload = function (e) {
            let avatar = document.getElementById("avatarPreview");
            // Nếu đang là div (chưa có ảnh)
            if (avatar.tagName === "DIV") {
                const img = document.createElement("img");
                img.id = "avatarPreview";img.src = e.target.result; img.className = "rounded-circle mb-2";
                img.width = 120;img.height = 120;img.style.objectFit = "cover";avatar.replaceWith(img);
            } 
            else {
                avatar.src = e.target.result;
            }
        };
        reader.readAsDataURL(file);
    });
});
<script src="{% static 'js/profile_info.js' %}"></script>

